name: "Update GeoLite2-Country.mmdb IPåº“æ¯å‘¨æ›´æ–°"

on:
  schedule:
    - cron: '0 0 * * 1'  # æ¯å‘¨ä¸€é›¶ç‚¹æ‰§è¡Œ
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  update-mmdb:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download and update GeoLite2-Country.mmdb
      run: |
        echo "å¼€å§‹ä¸‹è½½ GeoLite2-Country.mmdb..."
        
        # ä¸‹è½½æ–‡ä»¶ï¼Œæ·»åŠ é‡è¯•æœºåˆ¶
        for i in {1..3}; do
          if wget --timeout=30 --tries=3 https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-Country.mmdb -O GeoLite2-Country.mmdb.tmp; then
            echo "ä¸‹è½½æˆåŠŸ"
            mv GeoLite2-Country.mmdb.tmp GeoLite2-Country.mmdb
            break
          else
            echo "ä¸‹è½½å¤±è´¥ï¼Œé‡è¯• $i/3"
            sleep 10
          fi
        done
        
        # æ£€æŸ¥ä¸‹è½½æ˜¯å¦æˆåŠŸ
        if [ ! -f "GeoLite2-Country.mmdb" ]; then
          echo "ä¸‹è½½å¤±è´¥ï¼Œé€€å‡º"
          exit 1
        fi
        
        # éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆé˜²æ­¢ä¸‹è½½åˆ°é”™è¯¯é¡µé¢ï¼‰
        file_size=$(stat -f%z GeoLite2-Country.mmdb 2>/dev/null || stat -c%s GeoLite2-Country.mmdb)
        if [ "$file_size" -lt 1000000 ]; then  # å°äº1MBå¯èƒ½æ˜¯é”™è¯¯æ–‡ä»¶
          echo "ä¸‹è½½çš„æ–‡ä»¶å¤§å°å¼‚å¸¸: ${file_size} bytes"
          exit 1
        fi
        
        echo "æ–‡ä»¶å¤§å°: ${file_size} bytes"

    - name: Commit and push if changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        if git diff --quiet GeoLite2-Country.mmdb; then
          echo "GeoLite2-Country.mmdb æ–‡ä»¶æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        else
          echo "æ£€æµ‹åˆ° GeoLite2-Country.mmdb æ–‡ä»¶æœ‰å˜åŒ–ï¼Œå¼€å§‹æäº¤"
          git add GeoLite2-Country.mmdb
          git commit -m "ğŸ”„ æ›´æ–°IPåº“æ–‡ä»¶ $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "æäº¤å®Œæˆ"
        fi